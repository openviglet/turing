# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that GitHub does not certify.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Publish Packages

on:
  push:
    branches:
      - main
jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: Use Node.js 24.12.0
        uses: actions/setup-node@v5
        with:
          node-version: 24.12.0
          registry-url: "https://registry.npmjs.org"
          scope: "@viglet"
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven
      - name: Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" > private.key
          gpg --batch --import private.key
          gpg --list-secret-keys
          echo "GPG_TTY=$(tty)" >> $GITHUB_ENV
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Increment Version
        run: |
          mvn build-helper:parse-version versions:set -Dgpg.skip=true -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion} versions:commit
          cd turing-js-sdk/js-sdk-lib
          npm version patch
          npm run build
          git config user.name alexandre.oliveira
          git config user.email alexandre.oliveira@gmail.com
          git commit -m "Updated version in pom.xml" -a
          git push
      - name: Configure Maven Settings
        uses: s4u/maven-settings-action@894661b3ddae382f1ae8edbeab60987e08cf0788 # v4.0.0
        with:
          servers: |
            [{
              "id": "central",
              "username": "${{ secrets.OSSRH_USERNAME }}",
              "password": "${{ secrets.OSSRH_TOKEN }}"
            }]
      - name: Publish package
        run: |
          mvn --batch-mode -pl turing-commons,turing-java-sdk -P release -am deploy -DskipTests -Dturing.open-browser=false
        # cd turing-js-sdk/js-sdk-lib
        # npm publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      - name: Deploy Version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mvn install package -Dgpg.skip=true -Dturing.open-browser=false
          export TAG_NAME=v$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "TAG_NAME=${TAG_NAME}"
          gh release create ${TAG_NAME} --generate-notes
          gh release upload ${TAG_NAME} turing-app/target/viglet-turing.jar --clobber
          gh release upload ${TAG_NAME} turing-utils/target/turing-utils.zip --clobber
      - name: Deploy JavaDoc ðŸš€
        uses: MathieuSoysal/Javadoc-publisher.yml@fda475b197081ba1eca7a1dfadf0c017080a1623 # v3.0.2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          javadoc-branch: javadoc
          java-version: 25
          target-folder: docs/latest/javadoc
          javadoc-source-folder: target/reports/apidocs
